<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Anti-Poaching Risk Prediction</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2kGZk2kG2xg9e6Yf8w1gP1mYgX5eJ6hB0v3f4Tg=" crossorigin=""/>
  <style>
    body { font-family: Inter, system-ui, Arial, sans-serif; background:linear-gradient(135deg,#0f766e,#042f2e); color:#0f172a; margin:0; padding:24px; min-height:100vh; }
    .container { max-width:1100px; margin:auto; }
    h1 { text-align:center; color:#ecfeff; }
    .subtitle { text-align:center; color:#ccfbf1; margin-bottom:10px; }
    .card { background:#fff; border-radius:12px; padding:18px; box-shadow:0 10px 24px rgba(0,0,0,0.12); }
    .grid { display:grid; grid-template-columns: 1fr 420px; gap:16px; align-items:start; }
    .form-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
    label{font-weight:600}
    small{display:block;font-size:12px;color:#475569;margin-top:4px}
    select,input{width:100%; padding:8px 10px; margin-top:6px; border-radius:8px; border:1px solid #cbd5f5; font-size:14px}
    button{padding:10px 12px;border-radius:8px;border:none;background:#0d9488;color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:#f1f5f9;color:#0f172a;border:1px solid #cbd5f5}
    #map { height: 360px; border-radius:8px; }
    .result { margin-top:8px;padding:12px;border-radius:8px; display:none; }
    .low{background:#ecfeff;border-left:6px solid #0d9488}
    .high{background:#fff1f2;border-left:6px solid #dc2626}
    .explain { margin-top:12px; }
    .bar { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .bar .label { width:160px; font-size:13px; color:#0f172a; }
    .bar .vis { flex:1; height:14px; border-radius:8px; overflow:hidden; background:#eef2ff; }
    .bar .fill { height:100%; }
    .muted{color:#64748b;font-size:13px}
    .footer{margin-top:12px;text-align:center;font-size:12px;color:#475569}
    .error{color:#991b1b;margin-top:8px;font-weight:700}
  </style>
</head>
<body>
  <div class="container">
    <h1>üêæ Anti-Poaching Risk Prediction</h1>
    <p class="subtitle">Click map to pick location ‚Üí fill the form ‚Üí Predict ‚Üí See an explanation why</p>

    <div class="card">
      <div class="grid">
        <!-- Left: form -->
        <div>
          <form id="riskForm" onsubmit="return false;">
            <div class="form-grid">
              <div>
                <label>Species</label>
                <select name="species"><option>Tiger</option><option>Elephant</option><option>Rhino</option><option>Leopard</option><option>Pangolin</option></select>
              </div>
              <div>
                <label>State</label>
                <select name="state" id="stateSelect"><option value="">-- Select state --</option>
<option>Madhya Pradesh</option><option>Uttarakhand</option><option>Rajasthan</option><option>West Bengal</option><option>Assam</option><option>Kerala</option><option>Gujarat</option><option>Karnataka</option><option>Odisha</option><option>Himachal Pradesh</option></select>
                <small id="stateHint" class="muted">Choose state to show lat/lon range</small>
              </div>

              <div>
                <label>Latitude</label>
                <input type="number" step="0.0001" id="latitude" name="latitude" placeholder="Click map or enter value" />
              </div>
              <div>
                <label>Longitude</label>
                <input type="number" step="0.0001" id="longitude" name="longitude" placeholder="Click map or enter value" />
              </div>

              <div>
                <label>Time of Day</label>
                <select name="time_of_day"><option>Morning</option><option>Afternoon</option><option>Night</option></select>
              </div>
              <div>
                <label>Terrain Type</label>
                <select name="terrain_type"><option>Forest</option><option>Grassland</option><option>Wetland</option><option>Mountain</option><option>Scrub</option></select>
              </div>

              <div>
                <label>Distance to Village (km)</label>
                <input type="number" step="0.1" name="proximity_to_village_km" value="3" />
              </div>
              <div>
                <label>Distance to Road (km)</label>
                <input type="number" step="0.1" name="distance_to_road_km" value="5" />
              </div>

              <div>
                <label>Patrol in Last 24 Hours</label>
                <select name="patrol_presence_last_24h"><option value="1">Yes</option><option value="0">No</option></select>
              </div>
              <div>
                <label>Camera Trap Present</label>
                <select name="camera_trap_present"><option value="1">Yes</option><option value="0">No</option></select>
              </div>

              <div>
                <label>Past Poaching Incidents</label>
                <input type="number" name="past_poaching_incidents" value="0" />
              </div>
              <div>
                <label>Poacher Signs Count</label>
                <input type="number" name="poacher_signs_count" value="0" />
              </div>

              <div>
                <label>Market Value (USD)</label>
                <input type="number" name="market_value_usd" value="2000" />
              </div>
              <div>
                <label>Community Awareness (1‚Äì10)</label>
                <input type="number" min="1" max="10" name="community_awareness_score" value="6" />
              </div>
            </div>

            <div style="margin-top:10px; display:flex; gap:8px;">
              <button type="button" id="predictBtn" onclick="doPredict()">Predict</button>
              <button type="button" class="secondary" onclick="fillRandomLocation()">Fill random in-range</button>
              <button type="button" class="secondary" onclick="openDocs()">API Docs</button>
            </div>

            <div id="errorBox" class="error" style="display:none"></div>
            <div id="result" class="result"></div>
          </form>

          <div class="explain" id="explainBox" style="display:none">
            <h3 style="margin:6px 0">Why this prediction?</h3>
            <div id="explainList"></div>
            <small class="muted">Green bars push the prediction higher (towards HIGH risk). Red bars push it lower.</small>
          </div>
        </div>

        <!-- Right: map -->
        <div>
          <div id="map"></div>
          <div style="margin-top:8px;" class="muted">Click the map to set latitude/longitude. You can still manually edit the inputs.</div>
          <div id="latlonRangeText" style="margin-top:6px;" class="muted"></div>
        </div>
      </div>
    </div>

    <div class="footer">ML-powered anti-poaching decision support ‚Ä¢ Academic prototype</div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-V4i9Qzqg3z6ZZ3cIu3EwGx6g2v7q7Q1l7fF6g5Yw0Rk=" crossorigin=""></script>

<script>
/* ---------- config ---------- */
const backendPredict = "https://anti-poaching-project.onrender.com/predict";
const backendExplain = "https://anti-poaching-project.onrender.com/explain";

/* dataset-derived ranges (updated) */
const stateRanges = {
  "Assam":             {lat:[24.1793, 28.7293], lon:[91.1351, 95.1843]},
  "Gujarat":           {lat:[20.6742, 24.1503], lon:[69.4059, 73.0288]},
  "Himachal Pradesh":  {lat:[29.6463, 33.4447], lon:[74.6491, 78.4641]},
  "Karnataka":         {lat:[13.2367, 17.3336], lon:[73.9850, 77.8989]},
  "Kerala":            {lat:[8.2183, 12.4075],  lon:[74.2017, 78.3782]},
  "Madhya Pradesh":    {lat:[19.9267, 24.2686], lon:[76.3461, 79.9605]},
  "Odisha":            {lat:[18.4529, 22.4759], lon:[83.8550, 87.6928]},
  "Rajasthan":         {lat:[24.0967, 27.8451], lon:[70.9231, 74.6447]},
  "Uttarakhand":       {lat:[28.0152, 31.8810], lon:[77.0423, 80.9724]},
  "West Bengal":       {lat:[21.0603, 25.1401], lon:[86.0419, 89.6897]}
};

/* ---------- helpers & DOM ---------- */
const stateSelect = document.getElementById("stateSelect");
const latInput = document.getElementById("latitude");
const lonInput = document.getElementById("longitude");
const latlonRangeText = document.getElementById("latlonRangeText");
const stateHint = document.getElementById("stateHint");
const errorBox = document.getElementById("errorBox");
const resultBox = document.getElementById("result");
const explainBox = document.getElementById("explainBox");
const explainList = document.getElementById("explainList");

stateSelect.addEventListener("change", () => {
  const s = stateSelect.value;
  if (!s || !stateRanges[s]) {
    latlonRangeText.textContent = "";
    stateHint.textContent = "Choose state to show lat/lon range";
    return;
  }
  const r = stateRanges[s];
  latlonRangeText.textContent = `Lat: ${r.lat[0].toFixed(4)} ‚Üí ${r.lat[1].toFixed(4)} ; Lon: ${r.lon[0].toFixed(4)} ‚Üí ${r.lon[1].toFixed(4)}`;
  stateHint.textContent = `Lat/lon shown for ${s}. Clicking map sets coordinates.`;
});

/* ---------- Map ---------- */
const map = L.map('map').setView([22.5, 78.0], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let marker = null;
map.on('click', function(e) {
  const {lat, lng} = e.latlng;
  if (marker) marker.setLatLng(e.latlng);
  else marker = L.marker(e.latlng).addTo(map);
  latInput.value = lat.toFixed(6);
  lonInput.value = lng.toFixed(6);
});

/* ---------- utils ---------- */
function showError(msg){
  errorBox.style.display = "block";
  errorBox.textContent = msg;
}
function clearError(){
  errorBox.style.display = "none";
  errorBox.textContent = "";
}
function showResultHtml(html, high=false){
  resultBox.style.display="block";
  resultBox.className = "result " + (high ? "high":"low");
  resultBox.innerHTML = html;
}
function clearResult(){
  resultBox.style.display="none";
  resultBox.innerHTML="";
  explainBox.style.display="none";
  explainList.innerHTML="";
}

/* fill a random location inside selected state's range */
function fillRandomLocation(){
  const s = stateSelect.value;
  if (!s || !stateRanges[s]) { alert("Select a state first"); return; }
  const r = stateRanges[s];
  const lat = (Math.random() * (r.lat[1]-r.lat[0]) + r.lat[0]).toFixed(6);
  const lon = (Math.random() * (r.lon[1]-r.lon[0]) + r.lon[0]).toFixed(6);
  latInput.value = lat;
  lonInput.value = lon;
  const ll = L.latLng(Number(lat), Number(lon));
  if (marker) marker.setLatLng(ll); else marker = L.marker(ll).addTo(map);
  map.setView(ll, 9);
}

/* open docs in new tab */
function openDocs(){ window.open(backendPredict.replace("/predict","/docs"), "_blank"); }

/* ---------- validate lat/lon (warn not block) ---------- */
function validateLatLonWarn(){
  const s = stateSelect.value;
  if (!s) { showError("Please select a state"); return false; }
  const lat = Number(latInput.value), lon = Number(lonInput.value);
  if (!isFinite(lat) || !isFinite(lon)) { showError("Enter numeric latitude & longitude"); return false; }
  const r = stateRanges[s];
  if (!r) { showError("No lat/lon range for state"); return true; }
  if (lat < r.lat[0] || lat > r.lat[1] || lon < r.lon[0] || lon > r.lon[1]) {
    // show warning but allow submission
    showError(`Warning: Lat/lon outside typical ${s} range. Submission allowed.`);
    return true;
  }
  clearError();
  return true;
}

/* ---------- build payload from form and lat/lon ---------- */
function buildPayload() {
  const form = document.getElementById("riskForm");
  const data = Object.fromEntries(new FormData(form).entries());
  // convert numeric
  ["proximity_to_village_km","distance_to_road_km","past_poaching_incidents","poacher_signs_count","market_value_usd","community_awareness_score","patrol_presence_last_24h","camera_trap_present"].forEach(k => { if (data[k] !== undefined) data[k] = Number(data[k]) });
  // add lat/lon
  data.latitude = Number(latInput.value);
  data.longitude = Number(lonInput.value);
  return data;
}

/* ---------- call predict, then explain ---------- */
async function doPredict(){
  clearResult();
  if (!validateLatLonWarn()) return;

  const payload = buildPayload();
  const btn = document.getElementById("predictBtn");
  const oldText = btn.textContent;
  btn.textContent = "Predicting..."; btn.disabled = true;

  try {
    const res = await fetch(backendPredict, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(txt || `Status ${res.status}`);
    }
    const j = await res.json();
    const risk = Number(j.poaching_risk_score);
    const high = risk >= 0.5;
    showResultHtml(`<strong>Risk Score:</strong> ${risk.toFixed(3)}<br/><strong>Prediction:</strong> ${high ? "HIGH RISK" : "LOW RISK"}<br/><small class="muted">Model: ${j.model_version || "v1"}</small>`, high);

    // now ask for an explanation
    try {
      const exRes = await fetch(backendExplain, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      if (exRes.ok) {
        const ex = await exRes.json();
        renderExplanation(ex);
      } else {
        // ignore explanation error (non-fatal)
        console.warn("Explain failed", await exRes.text());
      }
    } catch (err) {
      console.warn("Explain request failed", err);
    }

  } catch (err) {
    console.error(err);
    showError("Prediction failed. Backend may be sleeping or unreachable.");
  } finally {
    btn.textContent = oldText; btn.disabled = false;
  }
}

/* ---------- render explanation (top_features) ---------- */
function renderExplanation(ex) {
  explainList.innerHTML = "";
  if (!ex || !ex.top_features) return;
  explainBox.style.display = "block";

  // find max abs to scale bars
  const maxAbs = Math.max(...ex.top_features.map(t => t.abs)) || 1;
  ex.top_features.forEach(item => {
    const wrap = document.createElement("div");
    wrap.className = "bar";
    const label = document.createElement("div"); label.className = "label"; label.textContent = item.feature;
    const vis = document.createElement("div"); vis.className = "vis";
    const fill = document.createElement("div"); fill.className = "fill";
    // scale fraction (0..1)
    const frac = Math.min(1, Math.abs(item.contribution) / maxAbs);
    fill.style.width = `${Math.round(frac*100)}%`;
    // positive -> push higher risk, color green-ish; negative -> push lower, color red-ish
    fill.style.background = item.contribution >= 0 ? "#10b981" : "#ef4444";
    vis.appendChild(fill);
    const txt = document.createElement("div"); txt.style.minWidth="80px"; txt.style.textAlign="right"; txt.style.fontSize="12px"; txt.style.color="#334155";
    txt.textContent = item.contribution.toFixed(3);
    wrap.appendChild(label); wrap.appendChild(vis); wrap.appendChild(txt);
    explainList.appendChild(wrap);
  });
}

/* ---------- initial map marker from default inputs (if present) ---------- */
(function init() {
  const lat = parseFloat(latInput.value), lon = parseFloat(lonInput.value);
  if (isFinite(lat) && isFinite(lon)) {
    const ll = L.latLng(lat, lon);
    marker = L.marker(ll).addTo(map);
    map.setView(ll, 9);
  }
})();
</script>
</body>
</html>
